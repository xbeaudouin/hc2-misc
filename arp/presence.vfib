{"name":"Pr√©sence XB","type":"virtual_device","properties":{"deviceIcon":1021,"currentIcon":"1021","mainLoop":"local thismodule = fibaro:getSelfId(); \nfibaro:call(thismodule, \"pressButton\", \"1\");\nfibaro:sleep(1000);\n-- fibaro:debug(thismodule);\nlocal status = fibaro:getGlobal(\"Phone_ikiwi\")\n\nif\n\tstatus == \"0\"\nthen \n\tfibaro:call(thismodule, \"setProperty\", \"currentIcon\", 1023)\nend\n\nif\n\tstatus == \"1\"\nthen \n\tfibaro:call(thismodule, \"setProperty\", \"currentIcon\", 1021)\nend\n\nfibaro:sleep(5*60*1000);","saveLogs":"1","rows":[{"type":"button","elements":[{"id":1,"lua":true,"waitForResponse":false,"caption":"Check if XB is Present","name":"ButtonXB","empty":false,"msg":"local thismodule = fibaro:getSelfId();\nlocal ip = fibaro:get(thismodule, 'IPAddress');\nlocal port = fibaro:get(thismodule, 'TCPPort');\nlocal cgi = \"/kiwi/arp.pl\";\nlocal what = \"ikiwi\";\n-- DON'T FORGET to create global variable Phone_ with \"what\" content\n-- ie if what=\"ikiwi\", then the GV will be : Phone_ikiwi\n\nfibaro:debug(\"ARP : http://\"..ip..\":\"..port..cgi);\n\nlocal arpstuff = pcall(function()\n    \n    local ARP = Net.FHttp(ip,port);\n\n    local response, status, errorCode = ARP:GET(cgi..\"?host=\"..what);\n    --fibaro:debug(\"Debug : r : \"..response..\"\\n\");\n    --fibaro:debug(\"Debug : s : \"..status..\"\\n\");\n    --fibaro:debug(\"Debug : e : \"..errorCode..\"\\n\");\n    if(tonumber(status)==200)\n    then\n\t-- enregistrement du retour de l API dans une table\n\tresponse = json.decode(response);\n\tfibaro:debug(response.hostname);\n\tfibaro:debug(response.MAC);\n\tif(response.MAC == \"unknown\")\n\tthen\n\t\tfibaro:debug(what..\" is not at home\");\n\t\tif (fibaro:getGlobalValue(\"Phone_\"..what)==\"1\")\n\t\tthen\n\t\t\tfibaro:setGlobal(\"Phone_\"..what,\"0\");\n\t\tend;\t\n\t\tfibaro:log(what..\" is not at home\");\n\telse\n\t\tfibaro:debug(what..\" is at home\");\n\t\tif (fibaro:getGlobalValue(\"Phone_\"..what)==\"0\")\n\t\tthen\n\t\t\tfibaro:setGlobal(\"Phone_\"..what,\"1\");\n\t\tend\n\t\tfibaro:log(what..\" is at home\");\n\tend;\n\t\t\t\n    else\n       fibaro:debug(\"status: \" .. tostring(status or \"\")); \n       fibaro:debug(\"error code: \" .. tostring(errorCode or \"\")); \n    end;\nend);\n    \n\nif (not arpstuff) then\n\tfibaro:debug(\"ARP polling failed\");\nend;\n","buttonIcon":1021,"favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}